# å¤šCTPè¿æ¥ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘é¡¹ç›®

```bash
cd qactpmdgateway
make all
```

### 2. è¿è¡Œæ¨¡å¼

#### å•CTPæ¨¡å¼ï¼ˆå…¼å®¹æ€§æ¨¡å¼ï¼‰
```bash
./bin/market_data_server --front-addr tcp://182.254.243.31:30011 --broker-id 9999 --port 7799
```

#### å¤šCTPæ¨¡å¼ï¼ˆæ¨èï¼‰

ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆSimNowç¯å¢ƒï¼‰ï¼š
```bash
./bin/market_data_server --multi-ctp
```

ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼š
```bash
./bin/market_data_server --config config/multi_ctp_config.json
```

æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
```bash
./bin/market_data_server --multi-ctp --strategy connection_quality
```

### 3. æŸ¥çœ‹è¿æ¥çŠ¶æ€

```bash
./bin/market_data_server --multi-ctp --status
```

## ğŸ“‹ é…ç½®æ–‡ä»¶æ ¼å¼

é…ç½®æ–‡ä»¶ä½¿ç”¨JSONæ ¼å¼ï¼Œç¤ºä¾‹ï¼š

```json
{
  "broker_id": "9999",
  "websocket_port": 7799,
  "redis_host": "192.168.2.27",
  "redis_port": 6379,
  "load_balance_strategy": "connection_quality",
  "health_check_interval": 30,
  "maintenance_interval": 60,
  "max_retry_count": 3,
  "auto_failover": true,
  "connections": [
    {
      "connection_id": "simnow_telecom",
      "front_addr": "tcp://180.168.146.187:10210",
      "broker_id": "9999",
      "max_subscriptions": 500,
      "priority": 1,
      "enabled": true
    }
  ]
}
```

### é…ç½®å‚æ•°è¯´æ˜

#### å…¨å±€é…ç½®
- `broker_id`: CTP Broker ID
- `websocket_port`: WebSocketæœåŠ¡ç«¯å£
- `redis_host`: RedisæœåŠ¡å™¨åœ°å€
- `redis_port`: RedisæœåŠ¡å™¨ç«¯å£
- `load_balance_strategy`: è´Ÿè½½å‡è¡¡ç­–ç•¥
- `health_check_interval`: å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
- `maintenance_interval`: ç»´æŠ¤ä»»åŠ¡é—´éš”ï¼ˆç§’ï¼‰
- `max_retry_count`: æœ€å¤§é‡è¯•æ¬¡æ•°
- `auto_failover`: æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§»

#### è¿æ¥é…ç½®
- `connection_id`: è¿æ¥å”¯ä¸€æ ‡è¯†
- `front_addr`: CTPå‰ç½®æœºåœ°å€
- `broker_id`: è¯¥è¿æ¥çš„Broker ID
- `max_subscriptions`: æœ€å¤§è®¢é˜…æ•°
- `priority`: è¿æ¥ä¼˜å…ˆçº§ï¼ˆ1-10ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
- `enabled`: æ˜¯å¦å¯ç”¨è¯¥è¿æ¥

## âš–ï¸ è´Ÿè½½å‡è¡¡ç­–ç•¥

### 1. Connection Quality (æ¨è)
```bash
--strategy connection_quality
```
æ ¹æ®è¿æ¥è´¨é‡è¯„åˆ†é€‰æ‹©æœ€ä½³è¿æ¥ï¼Œç»¼åˆè€ƒè™‘ï¼š
- è¿æ¥ç¨³å®šæ€§
- é”™è¯¯ç‡
- è®¢é˜…è´Ÿè½½
- ç½‘ç»œå»¶è¿Ÿ

### 2. Least Connections
```bash
--strategy least_connections
```
é€‰æ‹©å½“å‰è®¢é˜…æ•°æœ€å°‘çš„è¿æ¥

### 3. Round Robin
```bash
--strategy round_robin
```
è½®è¯¢æ–¹å¼åˆ†é…è¿æ¥

### 4. Hash Based
```bash
--strategy hash_based
```
åŸºäºåˆçº¦IDå“ˆå¸Œå€¼é€‰æ‹©è¿æ¥ï¼Œç¡®ä¿ç›¸åŒåˆçº¦æ€»æ˜¯åˆ†é…åˆ°ç›¸åŒè¿æ¥

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### è¿è¡Œå¤šCTPæµ‹è¯•è„šæœ¬

```bash
# å®‰è£…Pythonä¾èµ–
pip3 install websockets

# å¯åŠ¨æœåŠ¡å™¨ï¼ˆå¤šCTPæ¨¡å¼ï¼‰
./bin/market_data_server --multi-ctp &

# è¿è¡Œæµ‹è¯•è„šæœ¬
python3 test_multi_ctp.py

# æˆ–æŒ‡å®šæœåŠ¡å™¨åœ°å€
python3 test_multi_ctp.py ws://localhost:7799
```

### æµ‹è¯•é¡¹ç›®
- âœ… å¤§é‡åˆçº¦è®¢é˜…ï¼ˆå‡ åƒä¸ªåˆçº¦ï¼‰
- âœ… è´Ÿè½½å‡è¡¡éªŒè¯
- âœ… è¿æ¥çŠ¶æ€ç›‘æ§
- âœ… æ•…éšœè½¬ç§»æµ‹è¯•
- âœ… æ€§èƒ½ç»Ÿè®¡

## ğŸ”§ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MarketDataServer (ä¸»æ§åˆ¶å™¨)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SubscriptionDispatcher (å…¨å±€è®¢é˜…åˆ†å‘å™¨)            â”‚
â”‚  - å…¨å±€è®¢é˜…ç®¡ç†                                                â”‚
â”‚  - è´Ÿè½½å‡è¡¡ç®—æ³•                                                â”‚
â”‚  - æ•…éšœè½¬ç§»å¤„ç†                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                CTPConnectionManager                              â”‚
â”‚                   (å¤šè¿æ¥ç®¡ç†å™¨)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” 
â”‚ CTPConnection1â”‚ â”‚CTPConnection2â”‚ â”‚CTPConnection3â”‚ ... 
â”‚ Front-A       â”‚ â”‚ Front-B     â”‚ â”‚ Front-C     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½è®¢é˜…åˆ†å‘
- å…¨å±€è®¢é˜…å»é‡
- æ™ºèƒ½è´Ÿè½½å‡è¡¡
- è‡ªåŠ¨è¿æ¥é€‰æ‹©

### 2. æ•…éšœè½¬ç§»
- è¿æ¥å¥åº·ç›‘æ§
- è‡ªåŠ¨æ•…éšœæ£€æµ‹
- è®¢é˜…è¿ç§»

### 3. æ€§èƒ½ä¼˜åŒ–
- å¹¶å‘è¿æ¥ç®¡ç†
- å¼‚æ­¥æ¶ˆæ¯å¤„ç†
- Redisæ•°æ®ç¼“å­˜

### 4. ç›‘æ§ç»Ÿè®¡
- å®æ—¶è¿æ¥çŠ¶æ€
- è®¢é˜…åˆ†å¸ƒç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§

## ğŸ“Š WebSocket API

### è®¢é˜…åˆçº¦
```json
{
  "action": "subscribe",
  "instruments": ["rb2501", "i2501", "au2412"]
}
```

### å–æ¶ˆè®¢é˜…
```json
{
  "action": "unsubscribe", 
  "instruments": ["rb2501"]
}
```

### æŸ¥è¯¢åˆçº¦åˆ—è¡¨
```json
{
  "action": "list_instruments"
}
```

### æœç´¢åˆçº¦
```json
{
  "action": "search_instruments",
  "pattern": "rb"
}
```

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•ç¡®è®¤å¤šCTPæ¨¡å¼æ­£åœ¨å·¥ä½œï¼Ÿ
A: å¯åŠ¨æœåŠ¡å™¨æ—¶ä¼šæ˜¾ç¤ºï¼š
```
Multi-CTP Mode Configuration:
  Connections: 3 configured
  [simnow_telecom] tcp://180.168.146.187:10210
  [simnow_unicom] tcp://180.168.146.187:10211
  [simnow_mobile] tcp://218.202.237.33:10212
```

### Q: å¦‚ä½•ç›‘æ§è¿æ¥è´¨é‡ï¼Ÿ
A: ä½¿ç”¨ `--status` å‚æ•°æŸ¥çœ‹ï¼š
```bash
./bin/market_data_server --multi-ctp --status
```

### Q: é…ç½®æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ
A: 
- ç¤ºä¾‹é…ç½®ï¼š`config/multi_ctp_config.json`
- ç”Ÿäº§é…ç½®ï¼š`config/production_config.json`

### Q: å¦‚ä½•è°ƒæ•´æœ€å¤§è®¢é˜…æ•°ï¼Ÿ
A: ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ `max_subscriptions` å‚æ•°

### Q: å¦‚ä½•ç¦ç”¨æŸä¸ªè¿æ¥ï¼Ÿ
A: å°†é…ç½®æ–‡ä»¶ä¸­çš„ `enabled` è®¾ä¸º `false`

## ğŸ”’ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. é…ç½®ä¼˜åŒ–
```json
{
  "max_subscriptions": 1000,
  "health_check_interval": 15,
  "maintenance_interval": 30,
  "auto_failover": true
}
```

### 2. ç³»ç»Ÿä¼˜åŒ–
```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
ulimit -n 65536

# ä¼˜åŒ–ç½‘ç»œå‚æ•°
echo 'net.core.rmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 134217728' >> /etc/sysctl.conf
sysctl -p
```

### 3. ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# ç›‘æ§æœåŠ¡çŠ¶æ€
while true; do
    ./bin/market_data_server --status --config config/production_config.json
    sleep 60
done
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å…¸å‹æ€§èƒ½æ•°æ®
- æ”¯æŒå¹¶å‘è®¢é˜…: 5000+ åˆçº¦
- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ: <1ms
- å†…å­˜ä½¿ç”¨: ~100MB (æ— è®¢é˜…) - 500MB (æ»¡è½½)
- CPUä½¿ç”¨: 2-10% (4æ ¸æœåŠ¡å™¨)

### æ‰©å±•å»ºè®®
- å•æœºæ¨è: 3-5ä¸ªCTPè¿æ¥
- æ¯è¿æ¥å»ºè®®: 500-1000ä¸ªè®¢é˜…
- æ€»è®¢é˜…å»ºè®®: <5000ä¸ªåˆçº¦

---

æ›´å¤šé—®é¢˜è¯·æŸ¥çœ‹é¡¹ç›®READMEæˆ–æäº¤Issueã€‚